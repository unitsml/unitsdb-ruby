= UnitsDB in Ruby (UnitsML)

== Purpose

UnitsML is a standard for units of measure, and UnitsDB is the database
that contains enumerative elements used by UnitsML.

UnitsDB includes the following content:

* Unit systems
* Units of measure
* Prefixes
* Constants
* Quantities

Such content is hosted at the official UnitsDB repository at
https://github.com/unitsml/unitsdb.

This repository contains the Ruby codebase for UnitsDB, which is used
to access and manipulate the UnitsDB content.

== Install

[source,sh]
----
$ gem install unitsdb
----

== Usage: CLI

The UnitsDB gem includes a command-line utility for working with UnitsDB data.
This tool provides several commands for validating and normalizing UnitsDB
content.

=== Installation

The `unitsdb` command is automatically installed when you install the gem.

=== Available commands

==== Database Validation

Validates the database for different conditions:

[source,sh]
----
# Validate that all references exist
$ unitsdb validate references --database=/path/to/unitsdb/data

# Check for uniqueness of identifiers
$ unitsdb validate identifiers --database=/path/to/unitsdb/data
----

Options:

`--database`, `-d`:: Path to UnitsDB database (required)

==== Database Modification (_modify)

Commands that modify the database are grouped under the `_modify` namespace:

[source,sh]
----
# Normalize YAML file format
$ unitsdb _modify normalize [INPUT] [OUTPUT] --database=/path/to/unitsdb/data
$ unitsdb _modify normalize --all --database=/path/to/unitsdb/data
----

Options:

`--all`, `-a`:: Process all YAML files in the repository
`--database`, `-d`:: Path to UnitsDB database (required)
`--sort`:: Sort keys alphabetically (default: true)

The references validator also supports:

`--debug_registry`:: Show registry contents for debugging
`--print_valid`:: Print valid references too

==== Search

Searches for entities in the database and displays ID and ID Type information for each result:

[source,sh]
----
# Search by text content
$ unitsdb search meter --database=/path/to/unitsdb/data
$ unitsdb search meter --type=units --database=/path/to/unitsdb/data

# Search by ID
$ unitsdb search any-query --id=NISTu1 --database=/path/to/unitsdb/data
$ unitsdb search any-query --id=NISTu1 --id_type=nist --database=/path/to/unitsdb/data

# Output in different formats
$ unitsdb search meter --format=json --database=/path/to/unitsdb/data
$ unitsdb search kilo --format=yaml --database=/path/to/unitsdb/data
----

Options:

`--type`, `-t`:: Entity type to search (units, prefixes, quantities, dimensions, unit_systems)
`--id`, `-i`:: Search for an entity with a specific identifier
`--id_type`:: Filter the ID search by identifier type
`--format`:: Output format (text, json, yaml) - default is text
`--database`, `-d`:: Path to UnitsDB database (required)

==== Get

Retrieves and displays the full details of a specific entity by its identifier:

[source,sh]
----
# Get entity details by ID
$ unitsdb get meter --database=/path/to/unitsdb/data
$ unitsdb get m --database=/path/to/unitsdb/data

# Get entity with specific ID type
$ unitsdb get meter --id_type=si --database=/path/to/unitsdb/data

# Output in different formats
$ unitsdb get kilogram --format=json --database=/path/to/unitsdb/data
$ unitsdb get second --format=yaml --database=/path/to/unitsdb/data
----

Options:

`--id_type`:: Filter the search by identifier type
`--format`:: Output format (text, json, yaml) - default is text
`--database`, `-d`:: Path to UnitsDB database (required)

==== Check SI

Performs a comprehensive check of entities in the BIPM's SI digital framework TTL files against UnitsDB database entities. This combined command checks in both directions to ensure UnitsDB is a strict superset of the SI digital framework:

* From SI to UnitsDB: Ensures every TTL entity is referenced by at least one UnitsDB entity
* From UnitsDB to SI: Identifies UnitsDB entities that should reference TTL entities

[source,sh]
----
# Check all entity types and generate a report
$ unitsdb check_si --database=spec/fixtures/unitsdb --ttl-dir=spec/fixtures/bipm-si-ttl

# Check a specific entity type (units, quantities, or prefixes)
$ unitsdb check_si --entity-type=units --database=spec/fixtures/unitsdb --ttl-dir=spec/fixtures/bipm-si-ttl

# Check in a specific direction only
$ unitsdb check_si --direction=from_si --database=spec/fixtures/unitsdb --ttl-dir=spec/fixtures/bipm-si-ttl

# Update references and write to output directory
$ unitsdb check_si --output-updated-database=new_unitsdb --database=spec/fixtures/unitsdb --ttl-dir=spec/fixtures/bipm-si-ttl
----

Options:

`--entity-type`, `-e`:: Entity type to check (units, quantities, or prefixes). If not specified, all types are checked
`--ttl-dir`, `-t`:: Path to the directory containing SI digital framework TTL files (required)
`--output_updated_database`, `-o`:: Directory path to write updated YAML files with added SI references
`--direction`, `-r`:: Direction to check: 'to_si' (UnitsDB→TTL), 'from_si' (TTL→UnitsDB), or 'both' (default)
`--database`, `-d`:: Path to UnitsDB database (required)

===== SI References Workflow

When the BIPM updates their SI Digital Reference TTL files, follow these steps to ensure UnitsDB remains a strict superset:

1. Verify unreferenced TTL entries:
   * Run `unitsdb check_si --database=/path/to/unitsdb/data --ttl-dir=/path/to/si-framework`
   * Look for entries in the "SI [Entity Type] not mapped to our database" section
   * These are TTL entities that are not currently referenced by any UnitsDB entity

2. For each unreferenced TTL entry:
   * Search for matching entities in UnitsDB: `unitsdb search "entity_name" --database=/path/to/unitsdb/data`
   * If a match exists:
     ** Update its references manually in the appropriate YAML file
     ** Add a new reference with `authority: "si-digital-framework"` and the TTL URI
   * If no match exists:
     ** Create a new entity in the appropriate YAML file (units.yaml, quantities.yaml, or prefixes.yaml)
     ** Include the necessary reference to the TTL entity

3. Verify all references are complete:
   * Run `unitsdb check_si --database=/path/to/unitsdb/data --ttl-dir=/path/to/si-framework` again
   * Confirm no entries appear in the "SI [Entity Type] not mapped to our database" section
   * If needed, run with the output option to automatically add missing references:
     `unitsdb check_si --output-updated-database=/path/to/output/dir --database=/path/to/unitsdb/data --ttl-dir=/path/to/si-framework`

The `check_si` command ensures every entity in the BIPM's SI Digital Reference is properly referenced in UnitsDB:

* It verifies that every TTL entity has at least one corresponding UnitsDB entity referencing it
* It identifies UnitsDB entities that should reference SI Digital Framework but don't yet
* It can automatically update YAML files with proper references when used with the `--output-updated-database` option

=== Examples

Check identifiers for uniqueness:

[source,sh]
----
$ unitsdb validate identifiers --database=/path/to/unitsdb/data
----

Normalize all files in a directory:

[source,sh]
----
$ unitsdb _modify normalize --all --database=/path/to/unitsdb/data
----

Validate references in a specific directory:

[source,sh]
----
$ unitsdb validate references --database=/path/to/unitsdb/data
----



== Usage: Ruby

=== Loading the database

The primary way to load the UnitsDB data is through the `Database.from_db` method, which reads data from YAML files:

[source,ruby]
----
require 'unitsdb'

# Load from the UnitsDB data directory
db = Unitsdb::Database.from_db('/path/to/unitsdb/data')

# Access different collections
units = db.units
prefixes = db.prefixes
dimensions = db.dimensions
quantities = db.quantities
unit_systems = db.unit_systems
----

=== Database search methods

The UnitsDB Ruby gem provides several methods for searching and retrieving entities.

==== Search by text content

The `search` method allows you to find entities containing specific text in their identifiers, names, or descriptions:

[source,ruby]
----
# Search across all entity types
results = db.search(text: "meter")

# Search within a specific entity type
units_with_meter = db.search(text: "meter", type: "units")
----

==== Find entity by ID

The `get_by_id` method finds an entity with a specific identifier across all entity types:

[source,ruby]
----
# Find by ID across all entity types
meter_entity = db.get_by_id(id: "NISTu1")

# Find by ID with specific identifier type
meter_entity = db.get_by_id(id: "NISTu1", type: "nist")
----

==== Find entity by ID within a specific type collection

The `find_by_type` method searches for an entity by ID within a specific entity type collection:

[source,ruby]
----
# Find unit with specific ID
meter_unit = db.find_by_type(id: "NISTu1", type: "units")
----

=== Main Classes

The UnitsDB Ruby gem provides the following main classes.

==== Database

The `Database` class is the main container that holds all UnitsML components. It loads and provides access to units, prefixes, dimensions, quantities, and unit systems.

[source,ruby]
----
# Access database collections
db.units       # => Array of Unit objects
db.prefixes    # => Array of Prefix objects
db.dimensions  # => Array of Dimension objects
db.quantities  # => Array of Quantity objects
db.unit_systems # => Array of UnitSystem objects
----

==== Unit

The `Unit` class represents units of measure with their properties and relationships:

* Identifiers
* Short name
* Whether it's a root unit or can be prefixed
* Dimension reference
* Unit system references
* Unit names
* Symbol presentations
* Quantity references
* SI derived bases
* Root unit references

==== Prefix

The `Prefix` class represents prefixes for units (like kilo-, mega-, etc.):

* Identifiers
* Name
* Symbol presentations
* Base (e.g., 10)
* Power (e.g., 3 for kilo)

==== Dimension

The `Dimension` class represents physical dimensions (like length, mass, etc.):

* Identifiers
* Whether it's dimensionless
* Basic dimensions (length, mass, time, etc.)
* Dimension details (power, symbol, dimension symbols)
* Short name

==== UnitSystem

The `UnitSystem` class represents systems of units (like SI, Imperial, etc.):

* Identifiers
* Name
* Short name
* Whether it's acceptable

==== Quantity

The `Quantity` class represents physical quantities that can be measured:

* Identifiers
* Quantity type
* Quantity names
* Short name
* Unit references
* Dimension reference

=== Database files

The `Database.from_db` method reads the following YAML files:

* `prefixes.yaml` - Contains prefix definitions (e.g., kilo-, mega-)
* `dimensions.yaml` - Contains dimension definitions (e.g., length, mass)
* `units.yaml` - Contains unit definitions (e.g., meter, kilogram)
* `quantities.yaml` - Contains quantity definitions (e.g., length, mass)
* `unit_systems.yaml` - Contains unit system definitions (e.g., SI, Imperial)


== License

Copyright Ribose. BSD 2-clause license.
